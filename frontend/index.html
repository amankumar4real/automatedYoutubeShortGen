<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Shorts Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg: #0c1222;
        --bg-card: #111827;
        --bg-elevated: #1a2234;
        --border: #1e293b;
        --border-focus: #3b82f6;
        --text: #f1f5f9;
        --text-muted: #94a3b8;
        --text-dim: #64748b;
        --accent: #6366f1;
        --accent-hover: #4f46e5;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --radius: 12px;
        --radius-sm: 8px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.15);
      }
      * { box-sizing: border-box; }
      body {
        font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: var(--bg);
        color: var(--text);
        font-size: 15px;
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
      }
      .container {
        max-width: 720px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
      }
      .page { display: none; }
      .page.active { display: block; animation: fadeIn 0.2s ease; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      .card-prompts { animation: cardFadeIn 0.25s ease; }
      @keyframes cardFadeIn { from { opacity: 0; } to { opacity: 1; } }
      .logo-lockup {
        display: inline-flex;
        align-items: center;
        gap: 0.7rem;
        margin-bottom: 0.9rem;
      }
      .logo-badge {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(140deg, #7c3aed 0%, #6366f1 55%, #2563eb 100%);
        box-shadow: 0 6px 16px rgba(99, 102, 241, 0.35);
      }
      .logo-wordmark {
        display: inline-flex;
        flex-direction: column;
        line-height: 1.05;
      }
      .logo-title {
        font-size: 1rem;
        font-weight: 700;
        letter-spacing: -0.02em;
        color: var(--text);
      }
      .logo-subtitle {
        font-size: 0.68rem;
        color: var(--text-dim);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-top: 0.15rem;
      }

      h1 {
        font-size: 1.75rem;
        font-weight: 700;
        letter-spacing: -0.02em;
        margin: 0 0 0.25rem 0;
        color: var(--text);
      }
      h2 {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 0.75rem 0;
        color: var(--text);
      }
      .subtitle {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin: 0 0 1.5rem 0;
      }
      .card {
        background: var(--bg-card);
        border-radius: var(--radius);
        padding: 1.5rem 1.5rem;
        margin-bottom: 1.25rem;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        transition: opacity 0.2s ease, transform 0.15s ease;
      }
      .card:hover { border-color: #334155; }
      button { transition: background 0.15s, border-color 0.15s, transform 0.05s; }
      button:hover:not([disabled]) { transform: translateY(-1px); }
      button:active { transform: scale(0.98); }
      .card-header {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-dim);
        margin-bottom: 0.75rem;
      }
      label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.35rem;
        color: var(--text-muted);
      }
      input[type='text'],
      input[type='password'] {
        width: 100%;
        padding: 0.6rem 0.85rem;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--text);
        font-family: inherit;
        font-size: 0.9375rem;
        transition: border-color 0.15s, box-shadow 0.15s;
      }
      input[type='text']:focus,
      input[type='password']:focus {
        outline: none;
        border-color: var(--border-focus);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      }
      input[type='text']::placeholder,
      input[type='password']::placeholder {
        color: var(--text-dim);
      }
      input[type='checkbox'] {
        margin-right: 0.5rem;
        accent-color: var(--accent);
      }
      button {
        padding: 0.6rem 1.15rem;
        border-radius: var(--radius-sm);
        border: none;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.9375rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        transition: background 0.15s, transform 0.05s;
      }
      button[disabled] { opacity: 0.55; cursor: not-allowed; }
      button.primary {
        background: var(--accent);
        color: white;
      }
      button.primary:hover:not([disabled]) { background: var(--accent-hover); }
      button.secondary {
        background: var(--bg-elevated);
        color: var(--text);
        border: 1px solid var(--border);
      }
      button.secondary:hover:not([disabled]) {
        background: #243049;
        border-color: #334155;
      }
      button.danger {
        background: var(--error);
        color: white;
      }
      button.danger:hover:not([disabled]) { background: #dc2626; filter: brightness(1.05); }
      .prompt-block { font-size: 0.875rem; color: var(--text-muted); white-space: pre-wrap; word-break: break-word; padding: 0.75rem; background: var(--bg); border-radius: var(--radius-sm); border: 1px solid var(--border); }
      .scene-prompt { margin-bottom: 1rem; }
      .scene-prompt .scene-num { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-dim); margin-bottom: 0.35rem; }
      .status {
        font-family: ui-monospace, monospace;
        font-size: 0.8rem;
        color: var(--text-muted);
      }
      .pill {
        display: inline-block;
        padding: 0.25rem 0.65rem;
        border-radius: 999px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .pill-draft, .pill-queued { background: rgba(100, 116, 139, 0.25); color: #cbd5e1; }
      .pill-running, .pill-script_generated, .pill-audio_generated { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
      .pill-done, .pill-assembly_done { background: rgba(16, 185, 129, 0.2); color: #34d399; }
      .pill-error { background: rgba(239, 68, 68, 0.2); color: #f87171; }
      .pill-rejected { background: rgba(239, 68, 68, 0.18); color: #fca5a5; }
      .pill-waiting_for_clips { background: rgba(234, 179, 8, 0.2); color: #facc15; }
      video {
        width: 100%;
        max-width: 360px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: #000;
      }
      audio {
        width: 100%;
        max-width: 360px;
      }
      .audio-body {
        padding-top: 0.25rem;
      }
      textarea {
        width: 100%;
        min-height: 96px;
        padding: 0.6rem 0.85rem;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--text);
        font-family: inherit;
        font-size: 0.875rem;
        resize: vertical;
        transition: border-color 0.15s, box-shadow 0.15s;
      }
      textarea:focus {
        outline: none;
        border-color: var(--border-focus);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      }
      .row { display: flex; gap: 1rem; flex-wrap: wrap; }
      .grow { flex: 1 1 0; min-width: 0; }
      .small { font-size: 0.8125rem; color: var(--text-muted); }
      .copy-btn, .chip {
        background: var(--bg-elevated);
        border-radius: 999px;
        padding: 0.35rem 0.85rem;
        font-size: 0.8125rem;
        font-weight: 500;
        border: 1px solid var(--border);
        color: var(--text);
        cursor: pointer;
        transition: background 0.15s, border-color 0.15s;
      }
      .copy-btn:hover, .chip:hover { background: #243049; border-color: #334155; }
      .copy-btn-sm { padding: 0.35rem 0.65rem; font-size: 0.8125rem; }
      .prompts-voiceover-actions { display: flex; align-items: center; gap: 0.5rem; }
      .scene-prompt { display: flex; align-items: flex-start; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
      .scene-prompt .scene-prompt-content { flex: 1 1 0; min-width: 0; }
      .chip { margin: 0.25rem 0.25rem 0.25rem 0; }
      .chip.selected { border-color: var(--accent); background: rgba(99, 102, 241, 0.15); color: #a5b4fc; }
      .projects-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
      }
      .projects-header h1 { margin: 0; }
      .header-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .logged-in-text { font-size: 0.875rem; color: var(--text-muted); }
      .dropdown-caret { font-size: 0.65rem; opacity: 0.8; }
      .topic-row { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
      .suggest-btn-wrap { display: flex; flex-direction: column; justify-content: flex-end; min-width: 140px; }
      .topic-suggestions-wrapper { position: relative; }
      .suggestions-overlay {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 0.5rem;
        min-width: 260px;
        max-width: 320px;
        max-height: 280px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow), 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        z-index: 10;
        overflow: hidden;
      }
      .suggestions-overlay.is-visible { display: block; }
      .suggestions-overlay-title {
        padding: 0.75rem 1rem;
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--text);
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
      }
      .suggestions-overlay-list {
        max-height: 220px;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }
      .suggestions-overlay-list::-webkit-scrollbar { width: 6px; }
      .suggestions-overlay-list::-webkit-scrollbar-track { background: transparent; }
      .suggestions-overlay-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
      .suggestions-overlay-list::-webkit-scrollbar-thumb:hover { background: #334155; }
      .suggestions-overlay-list .chip {
        margin: 0;
        width: 100%;
        display: block;
        text-align: left;
        white-space: normal;
        padding: 0.5rem 0.75rem;
        box-sizing: border-box;
      }
      .suggestions-overlay-list .chip.selected { border-color: var(--accent); background: rgba(99, 102, 241, 0.15); color: #a5b4fc; }
      .suggestions-message { font-size: 0.8125rem; color: var(--text-muted); padding: 0.5rem 0; }
      .btn-full { width: 100%; justify-content: center; }
      .empty-projects { display: none; padding: 0.5rem 0; }
      .status-row { display: flex; align-items: center; margin-bottom: 0.5rem; gap: 0.75rem; }
      .status-project-id { font-size: 0.8125rem; }
      .prompts-card-head { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; }
      .script-decision-box { margin-top: 1rem; }
      .script-decision-msg { margin-top: 0.5rem; }
      .title-options-wrap { position: relative; }
      .title-options-overlay {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 0.5rem;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow), 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        z-index: 12;
        overflow: hidden;
      }
      .title-options-overlay.is-visible { display: block; }
      .title-option-btn {
        width: 100%;
        text-align: left;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text);
        padding: 0.55rem 0.75rem;
        cursor: pointer;
      }
      .title-option-btn:hover { background: #243049; border-color: #334155; }
      .project-list { list-style: none; padding: 0; margin: 0; }
      .project-list li {
        padding: 1rem 1.15rem;
        margin-bottom: 0.5rem;
        background: var(--bg-elevated);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
        transition: background 0.15s, border-color 0.15s;
      }
      .project-list li:hover {
        background: #1e293b;
        border-color: #334155;
      }
      .project-list .project-left { min-width: 0; }
      .project-list .project-title { font-weight: 600; margin-bottom: 0.2rem; }
      .project-list .project-details { font-size: 0.8125rem; color: var(--text-muted); }
      .project-list .project-right { display: flex; flex-direction: column; align-items: flex-end; flex-shrink: 0; }
      .project-list .project-right .pill { margin-bottom: 0.25rem; }
      .project-list .project-time { font-size: 0.75rem; color: var(--text-dim); }
      .stage-history { font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.75rem; }
      .stage-history div { margin: 0.25rem 0; }
      .link {
        color: var(--text-muted);
        text-decoration: none;
        font-size: 0.875rem;
        transition: color 0.15s;
      }
      .link:hover { color: var(--text); }
      .err { color: #f87171; font-size: 0.8125rem; margin-top: 0.5rem; }
      .login-wrap { max-width: 400px; }
      .btn-group { display: flex; gap: 0.75rem; flex-wrap: wrap; }
      .nav-back { display: inline-flex; align-items: center; gap: 0.35rem; }
      .detail-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; }
      button.danger {
        background: var(--error);
        color: white;
      }
      button.danger:hover:not([disabled]) { background: #dc2626; filter: brightness(1.05); }
      .prompt-block { font-size: 0.875rem; color: var(--text-muted); white-space: pre-wrap; word-break: break-word; padding: 0.75rem; background: var(--bg); border-radius: var(--radius-sm); border: 1px solid var(--border); }
      .scene-prompt { margin-bottom: 1rem; }
      .scene-prompt .scene-num { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-dim); margin-bottom: 0.35rem; }
      .waiting-box {
        margin-top: 1rem;
        padding: 1rem 1.15rem;
        background: var(--bg-elevated);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
      }
      .waiting-box .small { margin-bottom: 0.5rem; }
      code { font-size: 0.8em; background: var(--bg); padding: 0.15rem 0.4rem; border-radius: 4px; color: var(--text-muted); }
      input[type="file"] {
        font-size: 0.8125rem;
        color: var(--text-muted);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="pageLogin" class="page">
        <div class="logo-lockup" aria-label="Shorts Generator logo">
          <div class="logo-badge" aria-hidden="true">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 6.5C8 5.67 8.94 5.19 9.62 5.68L17.03 10.95C17.61 11.36 17.61 12.22 17.03 12.63L9.62 17.9C8.94 18.39 8 17.91 8 17.08V6.5Z" fill="white"/>
            </svg>
          </div>
          <div class="logo-wordmark">
            <span class="logo-title">Shorts Generator</span>
            <span class="logo-subtitle">AI Video Studio</span>
          </div>
        </div>
        <h1>Shorts Generator</h1>
        <p class="subtitle">Sign in or create an account to manage your shorts.</p>
        <div class="card login-wrap">
          <div class="card-header">API &amp; account</div>
          <div style="margin-bottom: 1rem">
            <label for="apiBaseAuth">API base URL</label>
            <input id="apiBaseAuth" type="text" value="http://localhost:4000" placeholder="https://your-api.example.com" />
          </div>
          <div style="margin-bottom: 1rem">
            <label for="authUsername">Username</label>
            <input id="authUsername" type="text" autocomplete="username" placeholder="Username" />
          </div>
          <div style="margin-bottom: 1.25rem">
            <label for="authPassword">Password</label>
            <input id="authPassword" type="password" autocomplete="current-password" placeholder="Password" />
          </div>
          <div class="btn-group">
            <button id="btnLogin" class="primary">Log in</button>
            <button id="btnRegister" class="secondary">Register</button>
          </div>
          <div id="authError" class="err"></div>
        </div>
      </div>

      <div id="pageProjects" class="page">
        <div class="projects-header">
          <div>
            <div class="logo-lockup" aria-label="Shorts Generator logo" style="margin-bottom: 0.6rem;">
              <div class="logo-badge" aria-hidden="true">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M8 6.5C8 5.67 8.94 5.19 9.62 5.68L17.03 10.95C17.61 11.36 17.61 12.22 17.03 12.63L9.62 17.9C8.94 18.39 8 17.91 8 17.08V6.5Z" fill="white"/>
                </svg>
              </div>
              <div class="logo-wordmark">
                <span class="logo-title">Shorts Generator</span>
                <span class="logo-subtitle">AI Video Studio</span>
              </div>
            </div>
            <h1>My Shorts</h1>
          </div>
          <div class="header-right">
            <span class="logged-in-text">Logged in <span class="dropdown-caret" aria-hidden="true">▾</span></span>
            <button type="button" id="btnLogout" class="secondary">Log out</button>
          </div>
        </div>
        <div class="card">
          <div class="card-header">New short</div>
          <label for="apiBase">API</label>
          <input id="apiBase" type="text" value="http://localhost:4000" placeholder="https://your-api.example.com" style="margin-bottom: 1rem;" />
          <div class="topic-suggestions-wrapper">
            <div class="topic-row">
              <div class="grow">
                <label for="topic">Topic</label>
                <input id="topic" type="text" placeholder="Type a topic" />
              </div>
              <div class="suggest-btn-wrap">
                <button id="btnSuggestTopic" type="button" class="secondary">Suggest topic</button>
              </div>
            </div>
            <div id="topicSuggestions" class="suggestions-overlay">
              <div class="suggestions-overlay-title">Suggested Topics</div>
              <div class="suggestions-overlay-list"></div>
            </div>
          </div>
          <button id="btnNewProject" type="button" class="primary btn-full">Create new short</button>
        </div>
        <div class="card">
          <div class="card-header">Your projects</div>
          <ul id="projectList" class="project-list"></ul>
          <div id="projectListEmpty" class="small empty-projects" style="display: none;">No projects yet. Create one above.</div>
        </div>
      </div>

      <div id="pageProjectDetail" class="page">
        <div class="detail-header">
          <a href="#/projects" id="backToProjects" class="link nav-back">← Back to projects</a>
          <button type="button" id="btnDeleteProject" class="danger" style="display: none;">Delete</button>
        </div>
        <h1 id="detailTopic">Project</h1>
        <div class="card card-status" id="detailStatusCard">
          <div class="card-header">Status</div>
          <div class="status-row">
            <div class="grow">
              <div id="detailProjectId" class="status status-project-id"></div>
            </div>
            <span id="detailStatusPill" class="pill pill-draft">draft</span>
          </div>
          <div id="detailError" class="err"></div>
          <div id="detailStageHistory" class="stage-history"></div>
          <div id="waitingForClipsBox" class="waiting-box" style="display: none;">
            <div class="small">
              Add these files, then <strong>Upload clips</strong> and <strong>Continue assembly</strong>.
              Name files <code>clip_0.mp4</code>, <code>clip_1.mp4</code>, etc.
            </div>
            <div class="small">You can select and upload multiple files in one action.</div>
            <ul id="requiredFilesList" class="small" style="margin: 0.5rem 0; padding-left: 1.25rem"></ul>
            <div class="row" style="align-items: center; margin-top: 0.75rem; gap: 0.5rem;">
              <input id="clipFiles" type="file" multiple accept="video/mp4" />
              <button id="uploadClipsBtn" type="button" class="secondary">Upload clips</button>
              <button id="continueBtn" type="button" class="primary">Continue assembly</button>
            </div>
          </div>
        </div>
        <div class="card" id="audioCard" style="display: none;">
          <div class="card-header">Audio</div>
          <div class="audio-body">
            <div class="small" style="margin-bottom: 0.35rem;">Voiceover track</div>
            <audio id="audioPlayer" controls></audio>
          </div>
        </div>
        <div class="card card-prompts" id="promptsCard" style="display: none;">
          <div class="prompts-card-head">
            <div class="card-header" style="margin-bottom: 0;">Video prompts</div>
            <div id="promptsVoiceoverWrap" class="prompts-voiceover-actions">
              <button type="button" class="secondary small" id="toggleVoiceover" aria-expanded="false">Show full voiceover</button>
              <button type="button" class="copy-btn copy-btn-sm" data-copy-target="promptsVoiceover">Copy</button>
            </div>
          </div>
          <div id="promptsVoiceover" class="prompt-block" style="display: none; margin-top: 0.5rem; margin-bottom: 1rem;"></div>
          <div id="promptsLoading" class="small" style="display: none;">Loading prompts…</div>
          <div id="promptsError" class="small err" style="display: none;"></div>
          <div id="promptsContent" style="display: none;">
            <div id="promptsScenes"></div>
          </div>
          <div id="scriptDecisionBox" class="waiting-box script-decision-box" style="display: none;">
            <div class="small">Review the generated script. Confirm to continue pipeline, or reject permanently.</div>
            <div class="btn-group" style="margin-top: 0.5rem;">
              <button id="confirmScriptBtn" type="button" class="primary">Confirm script</button>
              <button id="rejectScriptBtn" type="button" class="danger">Reject permanently</button>
            </div>
            <div id="scriptDecisionMsg" class="small script-decision-msg"></div>
          </div>
        </div>
        <div class="card" id="resultCard" style="display: none">
          <div class="card-header">Result</div>
          <div class="row" style="margin-top: 0; gap: 1.25rem;">
            <div>
              <video id="video" controls playsinline></video>
            </div>
            <div class="grow">
              <div style="margin-bottom: 0.75rem">
                <label for="title">Title</label>
                <div class="title-options-wrap">
                  <div class="row" style="align-items: center; margin-bottom: 0.25rem; gap: 0.5rem;">
                    <input id="title" type="text" class="grow" />
                    <button class="copy-btn" data-copy-target="title">Copy</button>
                    <button id="btnSuggestTitles" type="button" class="secondary">Suggest titles</button>
                  </div>
                  <div id="titleOptionsOverlay" class="title-options-overlay">
                    <div class="suggestions-overlay-title">Title options</div>
                    <div id="titleOptionsList" class="suggestions-overlay-list"></div>
                  </div>
                </div>
              </div>
              <div style="margin-bottom: 0.75rem">
                <label for="description">Description</label>
                <div class="row" style="align-items: flex-start; margin-bottom: 0.25rem; gap: 0.5rem;">
                  <textarea id="description" class="grow"></textarea>
                  <button class="copy-btn" data-copy-target="description">Copy</button>
                </div>
              </div>
              <div>
                <label for="tags">Tags (comma separated)</label>
                <div class="row" style="align-items: flex-start; margin-bottom: 0.25rem; gap: 0.5rem;">
                  <textarea id="tags" class="grow"></textarea>
                  <button class="copy-btn" data-copy-target="tags">Copy</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const AUTH_TOKEN_KEY = 'shorts_token';
      const API_BASE_KEY = 'shorts_api_base';
      const USER_NAME_KEY = 'shorts_username';

      function getToken() { return localStorage.getItem(AUTH_TOKEN_KEY); }
      function setToken(t) { if (t) localStorage.setItem(AUTH_TOKEN_KEY, t); else localStorage.removeItem(AUTH_TOKEN_KEY); }
      function setUserName(u) { if (u) localStorage.setItem(USER_NAME_KEY, u); else localStorage.removeItem(USER_NAME_KEY); }
      function getUserName() { return localStorage.getItem(USER_NAME_KEY) || ''; }
      function getApiBase() {
        const stored = localStorage.getItem(API_BASE_KEY);
        if (stored) return stored.replace(/\/$/, '');
        if (typeof window !== 'undefined' && window.location.origin && window.location.origin !== 'http://localhost:4000')
          return window.location.origin.replace(/\/$/, '');
        return 'http://localhost:4000'.replace(/\/$/, '');
      }
      function setApiBase(b) { localStorage.setItem(API_BASE_KEY, (b || '').replace(/\/$/, '')); }

      // In-memory topic suggestion state for the current session
      let suggestedTopics = [];
      let seenTopics = [];

      function normalizeTopic(t) {
        return (t || '').toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, ' ').trim();
      }
      function isAlreadySeen(topic, seen) {
        var n = normalizeTopic(topic);
        if (!n) return true;
        return seen.some(function(s) {
          var e = normalizeTopic(s);
          return e === n || e.indexOf(n) !== -1 || n.indexOf(e) !== -1;
        });
      }

      function authFetch(url, opts = {}) {
        const base = getApiBase();
        const fullUrl = url.startsWith('http') ? url : base + url;
        const headers = { ...(opts.headers || {}) };
        if (opts.body && typeof opts.body === 'string' && !headers['Content-Type']) headers['Content-Type'] = 'application/json';
        const token = getToken();
        if (token) headers['Authorization'] = 'Bearer ' + token;
        return fetch(fullUrl, { ...opts, headers }).then((res) => {
          if (res.status === 401) {
            setToken(null);
            window.location.hash = '#/login';
            throw new Error('Unauthorized');
          }
          return res;
        });
      }

      function showPage(id) {
        document.querySelectorAll('.page').forEach((p) => p.classList.remove('active'));
        const el = document.getElementById(id);
        if (el) el.classList.add('active');
      }

      function setStatusPill(el, status) {
        if (!el) return;
        el.textContent = (status || '').toString().replace(/_/g, ' ');
        el.className = 'pill ' + ({
          draft: 'pill-draft', script_generated: 'pill-script_generated', audio_generated: 'pill-audio_generated',
          waiting_for_clips: 'pill-waiting_for_clips', assembly_done: 'pill-assembly_done', rejected: 'pill-rejected', error: 'pill-error'
        }[status] || 'pill-draft');
      }

      function relativeTime(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        const now = new Date();
        const sec = Math.floor((now - d) / 1000);
        if (sec < 60) return 'Just now';
        if (sec < 3600) return Math.floor(sec / 60) + ' minutes ago';
        if (sec < 86400) return Math.floor(sec / 3600) + ' hours ago';
        if (sec < 604800) return Math.floor(sec / 86400) + ' days ago';
        return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      }

      function renderProjectList(projects) {
        const list = document.getElementById('projectList');
        const empty = document.getElementById('projectListEmpty');
        if (!list) return;
        list.innerHTML = '';
        if (!projects || !projects.length) {
          if (empty) empty.style.display = 'block';
          return;
        }
        if (empty) empty.style.display = 'none';
        projects.forEach((p) => {
          const li = document.createElement('li');
          const pillClass = p.status === 'assembly_done'
            ? 'pill-assembly_done'
            : p.status === 'waiting_for_clips'
              ? 'pill-waiting_for_clips'
              : p.status === 'rejected'
                ? 'pill-rejected'
                : p.status === 'error'
                  ? 'pill-error'
                  : 'pill-draft';
          const topic = (p.topic || 'Untitled').replace(/</g, '&lt;');
          const shortId = (p.projectId || '').length > 12 ? (p.projectId || '').slice(0, 10) + '…' : (p.projectId || '');
          const details = 'Project: ' + topic + (shortId ? '. ' + shortId : '');
          const timeStr = relativeTime(p.updatedAt);
          const statusLabel = (p.status || 'draft').replace(/_/g, ' ');
          li.innerHTML = '<div class="project-left"><div class="project-title">' + topic + '</div><div class="project-details">' + details + '</div></div><div class="project-right"><span class="pill ' + pillClass + '">' + statusLabel + '</span><span class="project-time">' + timeStr + '</span></div>';
          li.onclick = () => { window.location.hash = '#/projects/' + p.projectId; };
          list.appendChild(li);
        });
      }

      function applyRoute() {
        const rawHash = (window.location.hash || '#/').slice(1);
        const hash = rawHash.replace(/^\/+/, '');
        const token = getToken();
        if (!token && hash !== 'login' && hash !== '') {
          window.location.hash = '#/login';
          showPage('pageLogin');
          return;
        }
        if (hash === 'login' || hash === '') {
          if (token) {
            window.location.hash = '#/projects';
            loadProjectsPage();
          } else {
            showPage('pageLogin');
          }
          return;
        }
        if (hash === 'projects') {
          if (detailPollTimer) { clearInterval(detailPollTimer); detailPollTimer = null; }
          showPage('pageProjects');
          loadProjectsPage();
          return;
        }
        const match = hash.match(/^projects\/([^/]+)$/);
        if (match) {
          showPage('pageProjectDetail');
          loadProjectDetail(match[1]);
          return;
        }
        showPage('pageProjects');
        loadProjectsPage();
      }

      async function loadProjectsPage() {
        const userName = document.getElementById('userName');
        if (userName) userName.textContent = getUserName() || '(user)';
        try {
          const res = await authFetch('/api/projects');
          if (!res.ok) throw new Error('Failed to load projects');
          const projects = await res.json();
          renderProjectList(projects);
        } catch (e) {
          if (e.message !== 'Unauthorized') renderProjectList([]);
        }
      }

      let currentProjectId = null;
      let detailPollTimer = null;
      let currentAudioUrl = null;
      let currentAudioKey = null;
      let currentRequiredFiles = [];

      async function loadProjectScript(projectId) {
        const loadingEl = document.getElementById('promptsLoading');
        const errorEl = document.getElementById('promptsError');
        const contentEl = document.getElementById('promptsContent');
        const voiceoverWrap = document.getElementById('promptsVoiceoverWrap');
        const voiceoverEl = document.getElementById('promptsVoiceover');
        const scenesEl = document.getElementById('promptsScenes');
        const toggleBtn = document.getElementById('toggleVoiceover');
        if (loadingEl) loadingEl.style.display = 'block';
        if (errorEl) { errorEl.style.display = 'none'; errorEl.textContent = ''; }
        if (contentEl) contentEl.style.display = 'none';
        try {
          const res = await authFetch('/api/projects/' + encodeURIComponent(projectId) + '/script');
          if (currentProjectId !== projectId) return;
          if (!res.ok) {
            if (errorEl) { errorEl.textContent = 'Prompts will appear after script is generated.'; errorEl.style.display = 'block'; }
            return;
          }
          const script = await res.json();
          if (!script || !Array.isArray(script.scenes)) {
            if (errorEl) { errorEl.textContent = 'Prompts will appear after script is generated.'; errorEl.style.display = 'block'; }
            return;
          }
          if (loadingEl) loadingEl.style.display = 'none';
          if (contentEl) contentEl.style.display = 'block';
          if (script.voiceover && voiceoverEl) {
            voiceoverEl.textContent = script.voiceover;
            if (voiceoverWrap) voiceoverWrap.style.display = 'block';
          } else if (voiceoverWrap) voiceoverWrap.style.display = 'none';
          if (scenesEl) {
            scenesEl.innerHTML = script.scenes.map(function(s, i) {
              var sceneVo = s.voiceover ? '<div class="small" style="margin-top:0.35rem;color:var(--text-dim);">' + String(s.voiceover).replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>' : '';
              var promptOnlyId = 'scene-prompt-text-' + i;
              return '<div class="scene-prompt"><div class="scene-prompt-content"><div class="scene-num">Scene ' + (i + 1) + '</div><div class="prompt-block" id="' + promptOnlyId + '">' + String(s.prompt || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>' + sceneVo + '</div><button type="button" class="copy-btn copy-btn-sm" data-copy-target="' + promptOnlyId + '">Copy</button></div>';
            }).join('');
          }
          if (toggleBtn) {
            toggleBtn.setAttribute('aria-expanded', 'false');
            toggleBtn.textContent = 'Show full voiceover';
          }
          if (voiceoverEl) voiceoverEl.style.display = 'none';
        } catch (e) {
          if (currentProjectId !== projectId) return;
          if (loadingEl) loadingEl.style.display = 'none';
          if (errorEl) { errorEl.textContent = 'Prompts will appear after script is generated.'; errorEl.style.display = 'block'; }
        }
      }

      let detailScriptLoaded = false;
      async function loadProjectDetail(projectId) {
        currentProjectId = projectId;
        detailScriptLoaded = false;
        if (detailPollTimer) clearInterval(detailPollTimer);
        const statusCard = document.getElementById('detailStatusCard');
        const resultCard = document.getElementById('resultCard');
        const topicEl = document.getElementById('detailTopic');
        const projectIdEl = document.getElementById('detailProjectId');
        const statusPill = document.getElementById('detailStatusPill');
        const errorEl = document.getElementById('detailError');
        const stageHistoryEl = document.getElementById('detailStageHistory');
        const waitingBox = document.getElementById('waitingForClipsBox');
        const requiredList = document.getElementById('requiredFilesList');
        const audioCard = document.getElementById('audioCard');
        const audioEl = document.getElementById('audioPlayer');
        const scriptDecisionBox = document.getElementById('scriptDecisionBox');
        const scriptDecisionMsg = document.getElementById('scriptDecisionMsg');
        const confirmScriptBtn = document.getElementById('confirmScriptBtn');
        const rejectScriptBtn = document.getElementById('rejectScriptBtn');
        if (topicEl) topicEl.textContent = 'Loading…';
        if (statusCard) statusCard.style.display = 'block';
        if (resultCard) resultCard.style.display = 'none';

        function apply(data) {
          if (!data) return;
          if (topicEl) topicEl.textContent = data.topic || 'Project';
          if (projectIdEl) projectIdEl.textContent = 'Project ID: ' + (data.projectId || projectId);
          setStatusPill(statusPill, data.status);
          const showPrompts = ['script_generated', 'audio_generated', 'waiting_for_clips', 'assembly_done', 'rejected', 'error'].indexOf(data.status) !== -1;
          const awaitingScriptDecision = data.status === 'script_generated' && data.currentStage === 'script';
          const promptsCardEl = document.getElementById('promptsCard');
          const btnDelete = document.getElementById('btnDeleteProject');
          if (btnDelete) btnDelete.style.display = 'inline-flex';
          if (promptsCardEl) promptsCardEl.style.display = showPrompts ? 'block' : 'none';
          if (showPrompts && !detailScriptLoaded) {
            detailScriptLoaded = true;
            loadProjectScript(projectId);
          }
          if (scriptDecisionBox) scriptDecisionBox.style.display = awaitingScriptDecision ? 'block' : 'none';
          if (scriptDecisionMsg) scriptDecisionMsg.textContent = awaitingScriptDecision ? 'Pipeline is paused. Choose confirm or reject.' : '';
          if (confirmScriptBtn) confirmScriptBtn.disabled = false;
          if (rejectScriptBtn) rejectScriptBtn.disabled = false;
          if (data.status === 'assembly_done' || data.status === 'rejected' || data.status === 'error' || awaitingScriptDecision) {
            if (detailPollTimer) {
              clearInterval(detailPollTimer);
              detailPollTimer = null;
            }
          }
          if (errorEl) errorEl.textContent = data.errorMessage || '';
          if (stageHistoryEl) {
            const hist = data.stageHistory || [];
            stageHistoryEl.innerHTML = hist.length ? hist.map((h) => '<div>' + (h.stage || '') + ': ' + (h.status || '') + (h.at ? ' @ ' + h.at : '') + '</div>').join('') : '';
          }
          if (data.status === 'waiting_for_clips') {
            if (waitingBox) waitingBox.style.display = 'block';
            if (requiredList) requiredList.innerHTML = (data.requiredFiles || []).map((f) => '<li>' + f + '</li>').join('');
            currentRequiredFiles = Array.isArray(data.requiredFiles) ? data.requiredFiles.slice() : [];
          } else {
            if (waitingBox) waitingBox.style.display = 'none';
            currentRequiredFiles = [];
          }
          if (audioEl && audioCard) {
            const rawUrl = data.audioUrl || null;
            if (rawUrl) {
              const fullUrl = rawUrl.startsWith('http') ? rawUrl : getApiBase() + rawUrl;
              const key = fullUrl.split('?')[0]; // stable part of URL
              if (key !== currentAudioKey) {
                const wasPlaying = !audioEl.paused && !audioEl.ended;
                audioEl.src = fullUrl;
                currentAudioUrl = fullUrl;
                currentAudioKey = key;
                if (wasPlaying) {
                  audioEl.play().catch(() => {});
                }
              }
              audioCard.style.display = 'block';
            } else {
              if (currentAudioUrl) {
                audioEl.pause();
                audioEl.removeAttribute('src');
                currentAudioUrl = null;
                currentAudioKey = null;
              }
              audioCard.style.display = 'none';
            }
          }
          var videoEl = document.getElementById('video');
          var titleEl = document.getElementById('title');
          var descEl = document.getElementById('description');
          var tagsEl = document.getElementById('tags');
          if (videoEl) videoEl.removeAttribute('src');
          if (titleEl) titleEl.value = '';
          if (descEl) descEl.value = '';
          if (tagsEl) tagsEl.value = '';
          if (data.status === 'assembly_done') {
            if (resultCard) resultCard.style.display = 'block';
            if (videoEl && data.finalVideoUrl) {
              videoEl.src = data.finalVideoUrl.startsWith('http') ? data.finalVideoUrl : getApiBase() + data.finalVideoUrl;
            }
            authFetch('/api/projects/' + encodeURIComponent(projectId) + '/meta')
              .then(function(r) {
                if (!r.ok) return null;
                return r.json();
              })
              .then(function(meta) {
                if (!meta) return;
                if (currentProjectId !== projectId) return;
                var t = document.getElementById('title');
                var d = document.getElementById('description');
                var g = document.getElementById('tags');
                if (t) t.value = (meta.titles && meta.titles[0]) || '';
                if (d) d.value = meta.description || '';
                if (g) g.value = (meta.tags || []).join(', ');
              })
              .catch(function() {});
          } else {
            if (resultCard) resultCard.style.display = 'none';
            var titleOverlayEl = document.getElementById('titleOptionsOverlay');
            var titleListEl = document.getElementById('titleOptionsList');
            if (titleOverlayEl) titleOverlayEl.classList.remove('is-visible');
            if (titleListEl) titleListEl.innerHTML = '';
          }
        }

        try {
          const res = await authFetch('/api/projects/' + encodeURIComponent(projectId));
          if (!res.ok) throw new Error('Project not found');
          const data = await res.json();
          apply(data);
          detailPollTimer = setInterval(async () => {
            if (currentProjectId !== projectId) return;
            try {
              const r = await authFetch('/api/projects/' + encodeURIComponent(projectId));
              if (r.ok) apply(await r.json());
            } catch (_) {}
          }, 4000);
        } catch (e) {
          if (errorEl) errorEl.textContent = e.message || 'Failed to load project';
        }
      }

      window.addEventListener('hashchange', applyRoute);
      window.addEventListener('load', () => {
        document.getElementById('apiBaseAuth').value = getApiBase();
        document.getElementById('apiBase').value = getApiBase();
        document.getElementById('apiBase').addEventListener('change', function() { setApiBase(this.value); });
        document.getElementById('apiBaseAuth').addEventListener('change', function() { setApiBase(this.value); });
        const titleSuggestBtn = document.getElementById('btnSuggestTitles');
        const titleOptionsOverlay = document.getElementById('titleOptionsOverlay');
        const titleOptionsList = document.getElementById('titleOptionsList');

        function hideTitleOptions() {
          if (titleOptionsOverlay) titleOptionsOverlay.classList.remove('is-visible');
          if (titleOptionsList) titleOptionsList.innerHTML = '';
        }
        function showTitleOptions(titles) {
          if (!titleOptionsOverlay || !titleOptionsList) return;
          titleOptionsList.innerHTML = (titles || []).map(function(t, i) {
            var safe = String(t || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            return '<button type="button" class="title-option-btn" data-title-idx="' + i + '" data-title-text="' + safe + '">' + safe + '</button>';
          }).join('');
          titleOptionsOverlay.classList.add('is-visible');
        }

        document.getElementById('btnLogin').onclick = async () => {
          const base = document.getElementById('apiBaseAuth').value.trim();
          const username = document.getElementById('authUsername').value.trim();
          const password = document.getElementById('authPassword').value;
          document.getElementById('authError').textContent = '';
          if (!base || !username || !password) {
            document.getElementById('authError').textContent = 'Fill API URL, username and password.';
            return;
          }
          setApiBase(base);
          try {
            const res = await fetch((base.replace(/\/$/, '')) + '/api/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password })
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.error || 'Login failed');
            setToken(data.token);
            if (data.user && data.user.username) setUserName(data.user.username);
            window.location.hash = '#/projects';
          } catch (e) {
            document.getElementById('authError').textContent = e.message || 'Login failed';
          }
        };

        document.getElementById('btnRegister').onclick = async () => {
          const base = document.getElementById('apiBaseAuth').value.trim();
          const username = document.getElementById('authUsername').value.trim();
          const password = document.getElementById('authPassword').value;
          document.getElementById('authError').textContent = '';
          if (!base || !username || !password) {
            document.getElementById('authError').textContent = 'Fill API URL, username and password.';
            return;
          }
          setApiBase(base);
          try {
            const res = await fetch((base.replace(/\/$/, '')) + '/api/auth/register', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password })
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.error || 'Register failed');
            setToken(data.token);
            if (data.user && data.user.username) setUserName(data.user.username);
            window.location.hash = '#/projects';
          } catch (e) {
            document.getElementById('authError').textContent = e.message || 'Register failed';
          }
        };

        document.getElementById('btnLogout').onclick = () => {
          setToken(null);
          setUserName(null);
          window.location.hash = '#/login';
        };

        const suggestBtn = document.getElementById('btnSuggestTopic');
        const topicInput = document.getElementById('topic');
        const topicSuggestionsEl = document.getElementById('topicSuggestions');

        if (suggestBtn && topicInput && topicSuggestionsEl) {
          var overlayList = topicSuggestionsEl.querySelector('.suggestions-overlay-list');
          function showOverlay(html) {
            if (overlayList) overlayList.innerHTML = html;
            topicSuggestionsEl.classList.add('is-visible');
          }
          function hideOverlay() {
            topicSuggestionsEl.classList.remove('is-visible');
            if (overlayList) overlayList.innerHTML = '';
          }
          document.addEventListener('click', function(e) {
            if (!topicSuggestionsEl.classList.contains('is-visible')) return;
            if (topicSuggestionsEl.contains(e.target) || suggestBtn.contains(e.target)) return;
            hideOverlay();
          });
          suggestBtn.onclick = async () => {
            suggestBtn.disabled = true;
            const originalText = suggestBtn.textContent;
            suggestBtn.textContent = 'Fetching…';
            hideOverlay();
            try {
              const res = await authFetch('/api/topics/suggest', {
                method: 'POST',
                body: JSON.stringify({ previous: seenTopics })
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok || !data.topics || !Array.isArray(data.topics)) {
                throw new Error(data.error || 'No topics available');
              }
              var newOnes = data.topics.filter(function(t) { return !isAlreadySeen(t, seenTopics); });
              suggestedTopics = newOnes;
              seenTopics = seenTopics.concat(newOnes);
              topicInput.value = suggestedTopics[0] || topicInput.value || '';
              if (!newOnes.length) {
                showOverlay('<span class="suggestions-message">No new topics this batch. Click again for more.</span>');
              } else {
                var chipsHtml = suggestedTopics.map(function(t, idx) {
                  var cls = 'chip' + (idx === 0 ? ' selected' : '');
                  return '<button type="button" class="' + cls + '" data-idx="' + idx + '">' + t.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;') + '</button>';
                }).join('');
                showOverlay(chipsHtml);
                topicSuggestionsEl.querySelectorAll('button[data-idx]').forEach(function(btn) {
                  btn.addEventListener('click', function() {
                    var i = parseInt(btn.getAttribute('data-idx'), 10);
                    if (isNaN(i) || !suggestedTopics[i]) return;
                    topicInput.value = suggestedTopics[i];
                    topicSuggestionsEl.querySelectorAll('.chip').forEach(function(c) { c.classList.remove('selected'); });
                    btn.classList.add('selected');
                  });
                });
              }
            } catch (e) {
              showOverlay('<span class="suggestions-message err">' + ((e && e.message) || 'Topic suggestion failed') + '</span>');
            } finally {
              suggestBtn.disabled = false;
              suggestBtn.textContent = originalText;
            }
          };
        }

        document.getElementById('btnNewProject').onclick = async () => {
          const topic = document.getElementById('topic').value.trim();
          if (!topic) { alert('Enter a topic'); return; }
          const btn = document.getElementById('btnNewProject');
          btn.disabled = true;
          try {
            const res = await authFetch('/api/projects', {
              method: 'POST',
              body: JSON.stringify({ topic })
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.error || 'Failed to create project');
            window.location.hash = '#/projects/' + data.projectId;
          } catch (e) {
            alert(e.message || 'Failed to create project');
          } finally {
            btn.disabled = false;
          }
        };

        if (titleSuggestBtn && titleOptionsOverlay && titleOptionsList) {
          titleSuggestBtn.onclick = async () => {
            if (!currentProjectId) return;
            titleSuggestBtn.disabled = true;
            const originalText = titleSuggestBtn.textContent;
            titleSuggestBtn.textContent = 'Fetching…';
            hideTitleOptions();
            try {
              const res = await authFetch('/api/projects/' + encodeURIComponent(currentProjectId) + '/titles/suggest', {
                method: 'POST'
              });
              const data = await res.json().catch(() => ({}));
              if (!res.ok || !Array.isArray(data.titles)) throw new Error(data.error || 'Failed to fetch title options');
              showTitleOptions(data.titles.slice(0, 15));
            } catch (e) {
              alert((e && e.message) || 'Failed to fetch title options');
            } finally {
              titleSuggestBtn.disabled = false;
              titleSuggestBtn.textContent = originalText;
            }
          };

          titleOptionsList.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-title-text]');
            if (!btn) return;
            const titleInput = document.getElementById('title');
            const text = btn.getAttribute('data-title-text') || '';
            if (titleInput) titleInput.value = text;
            copyToClipboard(text).catch(() => {});
            hideTitleOptions();
          });

          document.addEventListener('click', (e) => {
            if (!titleOptionsOverlay.classList.contains('is-visible')) return;
            if (titleOptionsOverlay.contains(e.target) || titleSuggestBtn.contains(e.target)) return;
            hideTitleOptions();
          });
        }

        document.getElementById('confirmScriptBtn')?.addEventListener('click', async () => {
          if (!currentProjectId) return;
          const btn = document.getElementById('confirmScriptBtn');
          const rejectBtn = document.getElementById('rejectScriptBtn');
          const msgEl = document.getElementById('scriptDecisionMsg');
          if (btn) btn.disabled = true;
          if (rejectBtn) rejectBtn.disabled = true;
          if (msgEl) msgEl.textContent = 'Confirming script and resuming pipeline...';
          try {
            const res = await authFetch('/api/projects/' + encodeURIComponent(currentProjectId) + '/confirm-script', { method: 'POST' });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.error || 'Confirm failed');
            loadProjectDetail(currentProjectId);
          } catch (e) {
            if (msgEl) msgEl.textContent = (e && e.message) || 'Confirm failed';
            if (btn) btn.disabled = false;
            if (rejectBtn) rejectBtn.disabled = false;
          }
        });

        document.getElementById('rejectScriptBtn')?.addEventListener('click', async () => {
          if (!currentProjectId) return;
          if (!confirm('Reject this script permanently? This action cannot be undone.')) return;
          const btn = document.getElementById('rejectScriptBtn');
          const confirmBtn = document.getElementById('confirmScriptBtn');
          const msgEl = document.getElementById('scriptDecisionMsg');
          if (btn) btn.disabled = true;
          if (confirmBtn) confirmBtn.disabled = true;
          if (msgEl) msgEl.textContent = 'Rejecting script...';
          try {
            const res = await authFetch('/api/projects/' + encodeURIComponent(currentProjectId) + '/reject-script', { method: 'POST' });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.error || 'Reject failed');
            loadProjectDetail(currentProjectId);
          } catch (e) {
            if (msgEl) msgEl.textContent = (e && e.message) || 'Reject failed';
            if (btn) btn.disabled = false;
            if (confirmBtn) confirmBtn.disabled = false;
          }
        });

        document.getElementById('uploadClipsBtn').onclick = async () => {
          if (!currentProjectId) return;
          const input = document.getElementById('clipFiles');
          const files = input && input.files ? input.files : null;
          if (!files || !files.length) { alert('Select one or more clip_*.mp4 files first.'); return; }
          const pickedNames = Array.from(files).map((f) => f.name);
          const badNames = pickedNames.filter((n) => !/^clip_(\d+)\.mp4$/i.test(n));
          if (badNames.length) {
            alert('Invalid file names. Use exact clip_N.mp4 names.\n\nInvalid:\n- ' + badNames.join('\n- '));
            return;
          }
          if (currentRequiredFiles.length) {
            const nameSet = new Set(pickedNames);
            const missing = currentRequiredFiles.filter((n) => !nameSet.has(n));
            if (missing.length) {
              const proceed = confirm('Some required clips are not in this selection:\n- ' + missing.join('\n- ') + '\n\nUpload selected files anyway?');
              if (!proceed) return;
            }
          }
          const btn = document.getElementById('uploadClipsBtn');
          btn.disabled = true;
          btn.textContent = 'Uploading…';
          try {
            const form = new FormData();
            for (let i = 0; i < files.length; i++) {
              form.append('file' + i, files[i]);
            }
            const res = await authFetch('/api/projects/' + encodeURIComponent(currentProjectId) + '/clips', {
              method: 'POST',
              body: form
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.error || 'Upload failed');
            alert('Clips uploaded. You can now click Continue to assemble.');
            loadProjectDetail(currentProjectId);
          } catch (e) {
            alert(e.message || 'Upload failed');
          } finally {
            btn.disabled = false;
            btn.textContent = 'Upload clips';
          }
        };

        document.getElementById('continueBtn').onclick = async () => {
          if (!currentProjectId) return;
          const btn = document.getElementById('continueBtn');
          btn.disabled = true;
          btn.textContent = 'Running…';
          try {
            const res = await authFetch('/api/projects/' + encodeURIComponent(currentProjectId) + '/continue', { method: 'POST' });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.error || 'Continue failed');
            loadProjectDetail(currentProjectId);
          } catch (e) {
            alert(e.message || 'Continue failed');
          } finally {
            btn.disabled = false;
            btn.textContent = 'Continue assembly';
          }
        };

        document.getElementById('toggleVoiceover')?.addEventListener('click', function() {
          const expanded = this.getAttribute('aria-expanded') === 'true';
          const voiceoverEl = document.getElementById('promptsVoiceover');
          this.setAttribute('aria-expanded', expanded ? 'false' : 'true');
          this.textContent = expanded ? 'Show full voiceover' : 'Hide full voiceover';
          if (voiceoverEl) voiceoverEl.style.display = expanded ? 'none' : 'block';
        });

        document.getElementById('btnDeleteProject')?.addEventListener('click', async () => {
          if (!currentProjectId) return;
          if (!confirm('Delete this project? All data will be removed. This cannot be undone.')) return;
          const btn = document.getElementById('btnDeleteProject');
          if (btn) btn.disabled = true;
          try {
            const res = await authFetch('/api/projects/' + encodeURIComponent(currentProjectId), { method: 'DELETE' });
            if (!res.ok) throw new Error('Delete failed');
            window.location.hash = '#/projects';
            loadProjectsPage();
          } catch (e) {
            alert(e.message || 'Delete failed');
          } finally {
            if (btn) btn.disabled = false;
          }
        });

        function copyToClipboard(text) {
          const str = (text || '').toString();
          if (navigator.clipboard && window.isSecureContext) {
            return navigator.clipboard.writeText(str);
          }
          const textarea = document.createElement('textarea');
          textarea.value = str;
          textarea.style.position = 'fixed';
          textarea.style.left = '-9999px';
          textarea.style.top = '0';
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          try {
            const ok = document.execCommand('copy');
            document.body.removeChild(textarea);
            return ok ? Promise.resolve() : Promise.reject(new Error('execCommand failed'));
          } catch (e) {
            document.body.removeChild(textarea);
            return Promise.reject(e);
          }
        }

        document.body.addEventListener('click', (e) => {
          const btn = e.target.closest('.copy-btn');
          if (!btn) return;
          e.preventDefault();
          const targetId = btn.getAttribute('data-copy-target');
          if (!targetId) return;
          const el = document.getElementById(targetId);
          if (!el) return;
          const text = el.value != null ? el.value : (el.textContent || '').trim();
          const originalLabel = btn.textContent;
          copyToClipboard(text).then(() => {
            btn.textContent = 'Copied';
            setTimeout(() => { btn.textContent = originalLabel; }, 1500);
          }).catch(() => alert('Copy failed'));
        });

        applyRoute();
      });
    </script>
  </body>
</html>
